
ğŸ“ŒğŸ“ŒğŸ“ŒğŸ“ŒğŸ“Œ THIS FILES INCLUDES WHAT EACH API ROUTE S3 STORAGE DO, HOW THEY DO, WHY THEY DO ğŸ“ŒğŸ“ŒğŸ“ŒğŸ“ŒğŸ“Œ

âœ… ROUTE : "/invoice/get_pdf" :
WHAT IT DOES : 
This API Generates a PDF for the current userâ€™s invoice, uploads that PDF to S3, updates the invoice record with the S3 URL, and returns the invoice data plus local and S3 paths.

âœ… Short Summary â€“ What this file does
storage_service.py is the file uploader service in your backend.
It does NOT generate PDFs. It:
Accepts the PDF file name (generated earlier by pdf_service.py)
Finds the file in the local directory app/PDFs/
Uploads the file to AWS S3 using aioboto3 (async boto3)
Returns the public S3 URL
Deletes all old local PDF files except the latest one (cleanup)

In short:
Local PDF â†’ S3 bucket â†’ Return URL â†’ Clean local folder

âœ… services/storage_service.py :
The api Calls this upload_file_to_s3() fun and passes the pdf file path 

âœ…SHORT SUMMARY â€” Line-by-Line Explanation

IMPORTS
os â†’ handles file paths & deleting files
aioboto3 â†’ async AWS S3 client (non-blocking uploads)
Config (botocore) â†’ enables AWS Signature V4 security
Optional â†’ type hint (not used)
AsyncIOMotorClient â†’ Mongo driver (unused, can remove)
decouple.config â†’ loads .env variables safely

ğŸ” ENV VARIABLES
Loaded from .env:
AWS region
Access key
Secret key
S3 bucket name
Used for authentication + deciding upload destination.

ğŸ“¦ SESSION & PATHS
session = aioboto3.Session() â†’ reusable async S3 session
PDF_DIR = app/PDFs â†’ where local PDFs are stored before upload

ğŸš€ upload_pdf_to_s3(pdf_filename)
1. Build local file path
app/PDFs/<file>.pdf

2. Check file exists
If not â†’ error.

3. Create async S3 client
With region + credentials + signature v4.

4. Create S3 key
invoices/<filename>

5. Upload file
Async â†’ wonâ€™t block FastAPI.

6. Build public URL
https://bucket.s3.region.amazonaws.com/invoices/file.pdf

7. Cleanup local folder
Delete all old PDFs â†’ keep only the latest.

ğŸ¯ Final Output
Returns the public S3 URL of the uploaded PDF.